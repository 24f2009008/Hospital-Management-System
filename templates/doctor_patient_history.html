{% extends "doctor_base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="h3"><i class="fas fa-file-medical me-2"></i>Patient Medical History</h2>
            <p class="text-muted">Complete medical history and treatment records</p>
        </div>
    </div>

    <!-- Patient Information Card -->
    <div class="card shadow-sm border-primary mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Patient Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ patient.user.name }}</p>
                    <p><strong>Patient ID:</strong> PAT{{ "%06d"|format(patient.id) }}</p>
                    <p><strong>Age:</strong> {{ age }} years</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Gender:</strong> {{ patient.gender or 'Not specified' }}</p>
                    <p><strong>Blood Group:</strong> <span class="badge bg-danger">{{ patient.blood_group or 'N/A' }}</span></p>
                    <p><strong>Address:</strong> {{ patient.address or 'Not specified' }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical History Card -->
    <div class="card shadow-sm border-info mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-notes-medical me-2"></i>Medical History</h5>
        </div>
        <div class="card-body">
            {% if medical_history %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-info"><i class="fas fa-allergies me-2"></i>Allergies</h6>
                    <p class="border-start border-3 border-danger ps-3">
                        {{ medical_history.allergies or 'No known allergies' }}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-warning"><i class="fas fa-heartbeat me-2"></i>Chronic Conditions</h6>
                    <p class="border-start border-3 border-warning ps-3" style="white-space: pre-line;">
                        {{ medical_history.chronic_conditions or 'No chronic conditions recorded' }}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-success"><i class="fas fa-pills me-2"></i>Current Medications</h6>
                    <p class="border-start border-3 border-success ps-3" style="white-space: pre-line;">
                        {{ medical_history.current_medications or 'No current medications' }}
                    </p>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-danger"><i class="fas fa-procedures me-2"></i>Previous Surgeries</h6>
                    <p class="border-start border-3 border-danger ps-3">
                        {{ medical_history.previous_surgeries or 'No previous surgeries recorded' }}
                    </p>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>No medical history recorded for this patient yet.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Treatment History -->
    <div class="card shadow-sm border-success mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-prescription-bottle-alt me-2"></i>Treatment History</h5>
        </div>
        <div class="card-body">
            {% if treatments %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Diagnosis</th>
                            <th>Treatment Plan</th>
                            <th>Prescription</th>
                            <th>Notes</th>
                            <th>Next Visit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for treatment in treatments %}
                        <tr>
                            <td>{{ treatment.treatment_date.strftime('%Y-%m-%d') if treatment.treatment_date else 'N/A' }}</td>
                            <td>{{ treatment.diagnosis[:50] + '...' if treatment.diagnosis and treatment.diagnosis|length > 50 else treatment.diagnosis or 'N/A' }}</td>
                            <td>{{ treatment.treatment_plan[:50] + '...' if treatment.treatment_plan and treatment.treatment_plan|length > 50 else treatment.treatment_plan or 'N/A' }}</td>
                            <td>{{ treatment.prescription[:50] + '...' if treatment.prescription and treatment.prescription|length > 50 else treatment.prescription or 'No prescription' }}</td>
                            <td>{{ treatment.notes[:30] + '...' if treatment.notes and treatment.notes|length > 30 else treatment.notes or '-' }}</td>
                            <td>{{ treatment.next_visit_date or 'Not scheduled' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No treatment records found for this patient.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Appointment History -->
    <div class="card shadow-sm border-warning mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Appointment History</h5>
        </div>
        <div class="card-body">
            {% if appointments %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Appointment #</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appointment in appointments %}
                        <tr>
                            <td>#APT{{ "%03d"|format(appointment.id) }}</td>
                            <td>{{ appointment.appoint_date }}</td>
                            <td>{{ appointment.appoint_time }}</td>
                            <td>{{ appointment.reason_for_visit }}</td>
                            <td>
                                <span class="badge bg-{{ 
                                    'success' if appointment.status == 'Completed' else 
                                    'warning' if appointment.status == 'Booked' else 
                                    'danger' 
                                }}">
                                    {{ appointment.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No appointment records found.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mb-4">
        <a href="/doctor/patients" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Patients
        </a>
        <a href="/doctor/appointments" class="btn btn-outline-primary">
            <i class="fas fa-calendar-check"></i> View Appointments
        </a>
    </div>
</div>

<style>
.card {
    border-radius: 0.75rem;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.border-start {
    border-left-width: 3px !important;
}
</style>
{% endblock %}
