{% extends "patient_base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3">Book Appointment</h2>
        <p class="text-muted">Schedule an appointment with our expert doctors.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Appointment Details</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="/patient/appointments/book" id="filterForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="department_filter" class="form-label">Filter by Department</label>
                            <select class="form-select" id="department_filter" name="department_id" onchange="this.form.submit()">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if selected_department and selected_department.id == dept.id %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Select a department to filter doctors</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <a href="/patient/appointments/book" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-redo me-2"></i>Show All Doctors
                            </a>
                        </div>
                    </div>
                </form>
                
                <hr>
                
                <form method="POST" action="/patient/appointments/book">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="doctor_id" class="form-label">Select Doctor *</label>
                            <select class="form-select" id="doctor_id" name="doctor_id" required>
                                <option value="">Choose a doctor...</option>
                                {% for doctor in doctors %}
                                <option value="{{ doctor.id }}" 
                                        data-dept="{{ doctor.department.name if doctor.department else 'General' }}"
                                        {% if selected_doctor and selected_doctor.id == doctor.id %}selected{% endif %}>
                                    {{ doctor.user.name }} - {{ doctor.specialization or 'General' }} ({{ doctor.department.name if doctor.department else 'General' }})
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                {% if selected_department %}
                                    Showing doctors from {{ selected_department.name }} department
                                {% else %}
                                    Showing all available doctors
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="appoint_date" class="form-label">Appointment Date *</label>
                            <select class="form-select" id="appoint_date" name="appoint_date" required>
                                <option value="">Select date...</option>
                                <optgroup label="This Week">
                                    {% set today = date.today() %}
                                    {% for i in range(7) %}
                                        {% set current_date = today + timedelta(days=i) %}
                                        {% if current_date.weekday() < 6 %}
                                        <option value="{{ current_date.strftime('%Y-%m-%d') }}">
                                            {{ current_date.strftime('%A, %B %d, %Y') }}
                                            {% if i == 0 %} (Today){% elif i == 1 %} (Tomorrow){% endif %}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Next Week">
                                    {% for i in range(7, 14) %}
                                        {% set current_date = today + timedelta(days=i) %}
                                        {% if current_date.weekday() < 6 %}
                                        <option value="{{ current_date.strftime('%Y-%m-%d') }}">
                                            {{ current_date.strftime('%A, %B %d, %Y') }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="Later">
                                    {% for i in range(14, 30) %}
                                        {% set current_date = today + timedelta(days=i) %}
                                        {% if current_date.weekday() < 6 %}
                                        <option value="{{ current_date.strftime('%Y-%m-%d') }}">
                                            {{ current_date.strftime('%A, %B %d, %Y') }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                            </select>
                            <small class="text-muted">Weekdays only (Monday - Saturday)</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appoint_time" class="form-label">Appointment Time *</label>
                            <select class="form-select" id="appoint_time" name="appoint_time" required>
                                <option value="">Select time...</option>
                                <optgroup label="Morning (8 AM - 12 PM)">
                                    <option value="08:00">08:00 AM</option>
                                    <option value="08:30">08:30 AM</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="09:30">09:30 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                </optgroup>
                                <optgroup label="Afternoon (12 PM - 5 PM)">
                                    <option value="12:00">12:00 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="13:30">01:30 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="14:30">02:30 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="15:30">03:30 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="16:30">04:30 PM</option>
                                </optgroup>
                                <optgroup label="Evening (5 PM - 8 PM)">
                                    <option value="17:00">05:00 PM</option>
                                    <option value="17:30">05:30 PM</option>
                                    <option value="18:00">06:00 PM</option>
                                    <option value="18:30">06:30 PM</option>
                                    <option value="19:00">07:00 PM</option>
                                    <option value="19:30">07:30 PM</option>
                                    <option value="20:00">08:00 PM</option>
                                </optgroup>
                            </select>
                            <small class="text-muted">Select a convenient time slot</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Visit *</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  placeholder="Please describe your symptoms or reason for the appointment..." required></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Appointment availability depends on the doctor's schedule. If your selected time is not available, you'll be notified to choose another slot.
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/patient/dashboard" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Book Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Available Doctors</h5>
            </div>
            <div class="card-body">
                {% for doctor in doctors[:5] %}
                <div class="d-flex align-items-center mb-3">
                    <div class="user-avatar me-3">{{ doctor.user.name[3] if doctor.user.name.startswith('Dr.') else doctor.user.name[0] }}</div>
                    <div>
                        <h6 class="mb-0">{{ doctor.user.name }}</h6>
                        <small class="text-muted">{{ doctor.specialization or 'General' }}</small>
                        <br><small class="text-muted">{{ doctor.experience or 0 }} years exp.</small>
                    </div>
                </div>
                {% endfor %}
                
                <a href="/patient/doctors" class="btn btn-outline-primary btn-sm w-100 mt-2">
                    View All Doctors
                </a>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Appointment Guidelines</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Arrive 15 minutes early</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Bring valid ID and insurance</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>List current medications</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Prepare questions for doctor</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.form-select {
    cursor: pointer;
}

.form-select optgroup {
    font-weight: bold;
    font-style: normal;
    background-color: #f8f9fa;
    color: #495057;
}

.form-select option {
    padding: 8px;
}

.alert-info {
    background-color: #e7f3ff;
    border-color: #b3d9ff;
    color: #004085;
}
</style>
{% endblock %}